# CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²è¯´æ˜

æœ¬é¡¹ç›®å·²é…ç½® GitHub Actions è‡ªåŠ¨åŒ–å·¥ä½œæµï¼Œå®ç° Android APK çš„è‡ªåŠ¨æ„å»ºã€å‘å¸ƒå’Œç‰ˆæœ¬æ›´æ–°ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
.github/workflows/
â”œâ”€â”€ android-release.yaml       # ä¸»å·¥ä½œæµï¼šæ„å»ºã€éƒ¨ç½²ã€æ›´æ–°ç‰ˆæœ¬
â”œâ”€â”€ android-build-only.yaml    # æµ‹è¯•å·¥ä½œæµï¼šä»…æ„å»º APK
â”œâ”€â”€ README.md                   # å·¥ä½œæµè¯¦ç»†è¯´æ˜
â””â”€â”€ setup-guide.md             # å¿«é€Ÿé…ç½®æŒ‡å—
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¦–æ¬¡é…ç½®ï¼ˆå¿…éœ€ï¼‰

è¯·æŒ‰ç…§ [`.github/workflows/setup-guide.md`](.github/workflows/setup-guide.md) å®Œæˆä»¥ä¸‹é…ç½®ï¼š

- âœ… é…ç½® GitHub Secretsï¼ˆæœåŠ¡å™¨ä¿¡æ¯å’Œ SSH å¯†é’¥ï¼‰
- âœ… é…ç½®æœåŠ¡å™¨ç¯å¢ƒï¼ˆç›®å½•ã€Nginxã€Node.jsï¼‰
- âœ… ä¿®æ”¹å·¥ä½œæµå‚æ•°ï¼ˆåŸŸåã€Flutter ç‰ˆæœ¬ç­‰ï¼‰

### 2. æ—¥å¸¸ä½¿ç”¨

#### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

ä¿®æ”¹ä»£ç åç›´æ¥æ¨é€åˆ° main åˆ†æ”¯ï¼š

```bash
# 1. æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼‰
# ç¼–è¾‘ pubspec.yamlï¼Œä¿®æ”¹ version: 1.0.0+X ä¸­çš„ X

# 2. æäº¤ä»£ç 
git add .
git commit -m "feat: æ–°å¢åŠŸèƒ½"
git push origin main

# 3. GitHub Actions è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²
# è®¿é—® https://github.com/ä½ çš„ç”¨æˆ·å/potato_timer/actions æŸ¥çœ‹è¿›åº¦
```

#### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

1. è®¿é—® GitHub ä»“åº“çš„ **Actions** æ ‡ç­¾
2. é€‰æ‹© **Android Release & Deploy**
3. ç‚¹å‡» **Run workflow**
4. å¡«å†™å‚æ•°ï¼š
   - **ç‰ˆæœ¬å·**: ä¾‹å¦‚ `2`
   - **æ›´æ–°æ—¥å¿—**: ä¾‹å¦‚ `1. æ–°å¢åŠŸèƒ½\n2. ä¿®å¤bug`
5. ç‚¹å‡» **Run workflow** å¼€å§‹

## ğŸ“‹ å·¥ä½œæµè¯´æ˜

### android-release.yamlï¼ˆä¸»å·¥ä½œæµï¼‰

**è§¦å‘æ¡ä»¶**:
- æ¨é€åˆ° `main` åˆ†æ”¯ä¸”ä¿®æ”¹äº† `lib/`ã€`android/` æˆ– `pubspec.yaml`
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œæµç¨‹**:
1. âœ… æ£€å‡ºä»£ç 
2. âœ… é…ç½® Javaã€Flutterã€Node.js ç¯å¢ƒ
3. âœ… ä» `pubspec.yaml` è¯»å–ç‰ˆæœ¬å·
4. âœ… æ„å»º Release APK
5. âœ… é‡å‘½åä¸º `potato_timer_vX.apk`
6. âœ… ä¸Šä¼  APK åˆ°æœåŠ¡å™¨ `/root/potato_timer_server/updates/`
7. âœ… ä¸Šä¼ æœåŠ¡å™¨ä»£ç 
8. âœ… è¿è¡Œ `update-version.js` æ›´æ–°ç‰ˆæœ¬é…ç½®
9. âœ… é‡å¯æœåŠ¡å™¨æœåŠ¡
10. âœ… åˆ›å»º GitHub Release
11. âœ… æ˜¾ç¤ºæ„å»ºæ‘˜è¦

**ç»“æœ**:
- APK æ–‡ä»¶å‘å¸ƒåˆ°æœåŠ¡å™¨
- ç‰ˆæœ¬é…ç½®è‡ªåŠ¨æ›´æ–°
- å®¢æˆ·ç«¯ä¸‹æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹æ›´æ–°

### android-build-only.yamlï¼ˆæµ‹è¯•å·¥ä½œæµï¼‰

**è§¦å‘æ¡ä»¶**:
- Pull Request åˆ° `main` åˆ†æ”¯
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œæµç¨‹**:
1. æ„å»º APK
2. è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
3. ä»£ç åˆ†æï¼ˆå¯é€‰ï¼‰
4. ä¸Šä¼  APK ä¸º Artifact

**ç”¨é€”**:
- æµ‹è¯•æ„å»ºæµç¨‹
- PR é¢„è§ˆ
- ä¸‹è½½æµ‹è¯•ç‰ˆæœ¬

## ğŸ“¦ ç‰ˆæœ¬å·ç®¡ç†

### ç‰ˆæœ¬å·æ ¼å¼

åœ¨ `pubspec.yaml` ä¸­ï¼š

```yaml
version: 1.0.0+1
#        ^^^^^ ^^
#        |     |
#        |     +-- æ„å»ºå·ï¼ˆBuild Numberï¼‰- ç”¨ä½œç‰ˆæœ¬æ›´æ–°çš„ç‰ˆæœ¬å·
#        +-------- è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆSemantic Versionï¼‰
```

### æ›´æ–°ç‰ˆæœ¬

**è‡ªåŠ¨æ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼š
1. ç¼–è¾‘ `pubspec.yaml`
2. å°† `version: 1.0.0+1` æ”¹ä¸º `version: 1.0.0+2`
3. æäº¤å¹¶æ¨é€
4. å·¥ä½œæµè‡ªåŠ¨ä½¿ç”¨æ„å»ºå· `2` ä½œä¸ºç‰ˆæœ¬å·

**æ‰‹åŠ¨æ¨¡å¼**ï¼š
- åœ¨æ‰‹åŠ¨è§¦å‘å·¥ä½œæµæ—¶æŒ‡å®šä»»æ„ç‰ˆæœ¬å·

### ç‰ˆæœ¬å·è§„åˆ™

- æ„å»ºå·å¿…é¡»æ˜¯æ•´æ•°
- åªè¦æœåŠ¡ç«¯ç‰ˆæœ¬å· > å®¢æˆ·ç«¯ç‰ˆæœ¬å·ï¼Œå°±ä¼šè§¦å‘æ›´æ–°
- å»ºè®®æŒ‰é¡ºåºé€’å¢ï¼š1, 2, 3, 4...

## ğŸ”§ é…ç½®é¡¹è¯´æ˜

### GitHub Secretsï¼ˆå¿…éœ€ï¼‰

| Secret | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `SERVER_IP` | æœåŠ¡å™¨ IP åœ°å€ | `123.456.789.0` |
| `SERVER_SSH_USER` | SSH ç”¨æˆ·å | `root` |
| `SERVER_SSH_KEY` | SSH ç§é’¥å®Œæ•´å†…å®¹ | `-----BEGIN RSA PRIVATE KEY-----\n...` |

### å·¥ä½œæµå‚æ•°ï¼ˆéœ€ä¿®æ”¹ï¼‰

åœ¨ `android-release.yaml` ä¸­ï¼š

| è¡Œå· | å‚æ•° | è¯´æ˜ |
|------|------|------|
| 29 | `flutter-version` | Flutter ç‰ˆæœ¬ï¼Œæ”¹ä¸ºä½ çš„ç‰ˆæœ¬ |
| 81 | `target` | APK ä¸Šä¼ è·¯å¾„ï¼Œæ ¹æ®æœåŠ¡å™¨è°ƒæ•´ |
| 92 | `target` | æœåŠ¡å™¨ä»£ç è·¯å¾„ï¼Œæ ¹æ®æœåŠ¡å™¨è°ƒæ•´ |
| 115 | `DOWNLOAD_URL` | APK ä¸‹è½½åœ°å€ï¼Œæ”¹ä¸ºä½ çš„åŸŸå |
| 127 | `systemctl restart` | æœåŠ¡é‡å¯å‘½ä»¤ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ |

## ğŸŒ æœåŠ¡å™¨é…ç½®

### ç›®å½•ç»“æ„

```
/root/potato_timer_server/
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ update-version.js      # ç‰ˆæœ¬æ›´æ–°è„šæœ¬
â”œâ”€â”€ updates/                    # APK å­˜æ”¾ç›®å½•
â”‚   â”œâ”€â”€ potato_timer_v1.apk
â”‚   â”œâ”€â”€ potato_timer_v2.apk
â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/                        # æœåŠ¡å™¨ä»£ç 
â”œâ”€â”€ version-config.json         # ç‰ˆæœ¬é…ç½®æ–‡ä»¶
â””â”€â”€ package.json
```

### Nginx é…ç½®ç¤ºä¾‹

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # API ä»£ç†
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
    }

    # APK ä¸‹è½½
    location /updates/ {
        alias /root/potato_timer_server/updates/;
        types {
            application/vnd.android.package-archive apk;
        }
        add_header Content-Disposition 'attachment';
    }
}
```

## ğŸ“Š ç›‘æ§å’ŒéªŒè¯

### æŸ¥çœ‹æ„å»ºçŠ¶æ€

è®¿é—®ï¼š`https://github.com/ä½ çš„ç”¨æˆ·å/potato_timer/actions`

### éªŒè¯éƒ¨ç½²ç»“æœ

```bash
# 1. æ£€æŸ¥ APK æ–‡ä»¶
ssh root@your-server-ip "ls -lh /root/potato_timer_server/updates/"

# 2. æ£€æŸ¥ç‰ˆæœ¬é…ç½®
ssh root@your-server-ip "cat /root/potato_timer_server/version-config.json"

# 3. æµ‹è¯•ç‰ˆæœ¬æ£€æŸ¥ API
curl http://your-domain.com/api/version/check

# 4. æµ‹è¯• APK ä¸‹è½½
curl -I http://your-domain.com/updates/potato_timer_v2.apk
```

### å®¢æˆ·ç«¯æµ‹è¯•

1. å¯åŠ¨ Flutter åº”ç”¨
2. åº”åœ¨ 1 ç§’åå¼¹å‡ºæ›´æ–°æç¤º
3. ç­‰å¾…ä¸‹è½½å®Œæˆ
4. ç‚¹å‡»"ç«‹å³æ›´æ–°"æµ‹è¯•å®‰è£…

## ğŸ› æ•…éšœæ’é™¤

### æ„å»ºå¤±è´¥

**Flutter ç‰ˆæœ¬ä¸åŒ¹é…**:
```bash
# æŸ¥çœ‹æœ¬åœ° Flutter ç‰ˆæœ¬
flutter --version

# ä¿®æ”¹å·¥ä½œæµä¸­çš„ç‰ˆæœ¬å·ï¼ˆç¬¬ 29 è¡Œï¼‰
flutter-version: 'ä½ çš„ç‰ˆæœ¬'
```

**ä¾èµ–å®‰è£…å¤±è´¥**:
- æ£€æŸ¥ `pubspec.yaml` æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
- æŸ¥çœ‹ Actions æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯ä¿¡æ¯

### éƒ¨ç½²å¤±è´¥

**SSH è¿æ¥å¤±è´¥**:
- æ£€æŸ¥ `SERVER_IP` æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ `SERVER_SSH_KEY` æ˜¯å¦å®Œæ•´
- ç¡®è®¤æœåŠ¡å™¨å…è®¸ SSH è¿æ¥

**æ–‡ä»¶ä¸Šä¼ å¤±è´¥**:
- ç¡®è®¤æœåŠ¡å™¨ç›®å½•å­˜åœ¨
- æ£€æŸ¥ç›®å½•æƒé™ï¼š`chmod 755 /root/potato_timer_server/updates`

**ç‰ˆæœ¬é…ç½®æ›´æ–°å¤±è´¥**:
- ç¡®è®¤ Node.js å·²å®‰è£…
- æ£€æŸ¥ `scripts/update-version.js` æ˜¯å¦å­˜åœ¨
- æŸ¥çœ‹ SSH æ‰§è¡Œæ—¥å¿—

### APK ä¸‹è½½å¤±è´¥

**404 é”™è¯¯**:
- æ£€æŸ¥ Nginx é…ç½®
- ç¡®è®¤ APK æ–‡ä»¶å­˜åœ¨
- æ£€æŸ¥æ–‡ä»¶æƒé™ï¼š`chmod 644 /root/potato_timer_server/updates/*.apk`

**ä¸‹è½½åœ°å€ä¸æ­£ç¡®**:
- ä¿®æ”¹å·¥ä½œæµç¬¬ 115 è¡Œçš„ `DOWNLOAD_URL`
- ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åŸŸåæˆ– IP

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [`.github/workflows/README.md`](.github/workflows/README.md) - å·¥ä½œæµè¯¦ç»†è¯´æ˜
- [`.github/workflows/setup-guide.md`](.github/workflows/setup-guide.md) - é…ç½®æŒ‡å—
- [`server/VERSION_UPDATE_GUIDE.md`](server/VERSION_UPDATE_GUIDE.md) - ç‰ˆæœ¬æ›´æ–°æœåŠ¡è¯´æ˜
- [`VERSION_UPDATE_API.md`](VERSION_UPDATE_API.md) - API æ¥å£æ–‡æ¡£

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬ç®¡ç†**
   - ä½¿ç”¨ `pubspec.yaml` ç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬å·
   - æ¯æ¬¡å‘å¸ƒå‰æ›´æ–°æ„å»ºå·
   - ä¿æŒç‰ˆæœ¬å·é€’å¢

2. **æ›´æ–°æ—¥å¿—**
   - æ¸…æ™°æè¿°æ¯æ¬¡æ›´æ–°çš„å†…å®¹
   - ä½¿ç”¨ `\n` åˆ†éš”å¤šæ¡æ›´æ–°
   - çªå‡ºé‡è¦åŠŸèƒ½å’Œä¿®å¤

3. **æµ‹è¯•æµç¨‹**
   - å…ˆåœ¨ PR ä¸­æµ‹è¯•æ„å»ºï¼ˆè§¦å‘ build-only å·¥ä½œæµï¼‰
   - åˆå¹¶åˆ° main å‰ç¡®ä¿æ„å»ºæˆåŠŸ
   - éƒ¨ç½²ååŠæ—¶éªŒè¯

4. **å®‰å…¨æ€§**
   - å®šæœŸæ›´æ–° SSH å¯†é’¥
   - ä½¿ç”¨ HTTPS ä¸‹è½½ APK
   - ä¸ºç®¡ç†æ¥å£æ·»åŠ é‰´æƒ

5. **ç›‘æ§**
   - å®šæœŸæŸ¥çœ‹ Actions è¿è¡Œæ—¥å¿—
   - ç›‘æ§æœåŠ¡å™¨ç£ç›˜ç©ºé—´
   - è®°å½•ç‰ˆæœ¬å‘å¸ƒå†å²

## âš¡ é«˜çº§åŠŸèƒ½

### æ·»åŠ ç­¾åé…ç½®

å‚è€ƒ [setup-guide.md](.github/workflows/setup-guide.md) ç¬¬å…­æ­¥ã€‚

### ç°åº¦å‘å¸ƒ

å¯ä»¥ä¿®æ”¹æœåŠ¡å™¨ç«¯ APIï¼Œæ·»åŠ ç”¨æˆ·ç™½åå•æœºåˆ¶ï¼Œå®ç°ç°åº¦å‘å¸ƒã€‚

### å¤šæ¸ é“æ‰“åŒ…

ä¿®æ”¹å·¥ä½œæµï¼Œæ·»åŠ å¤šä¸ªæ„å»ºæ­¥éª¤ï¼Œä¸ºä¸åŒæ¸ é“ç”Ÿæˆä¸åŒçš„ APKã€‚

### é€šçŸ¥é›†æˆ

åœ¨å·¥ä½œæµæœ«å°¾æ·»åŠ é€šçŸ¥æ­¥éª¤ï¼Œå‘é€åˆ°é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰ã€‚

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ [setup-guide.md](.github/workflows/setup-guide.md) æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥ GitHub Actions æ—¥å¿—
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
4. æäº¤ Issue æè¿°é—®é¢˜

---

**é…ç½®å®Œæˆåï¼Œä½ åªéœ€è¦ä¸“æ³¨äºå¼€å‘ï¼Œæ¨é€ä»£ç å³å¯è‡ªåŠ¨å®Œæˆæ„å»ºå’Œéƒ¨ç½²ï¼** ğŸ‰

