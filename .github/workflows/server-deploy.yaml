name: Deploy Server

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload server files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "server/*"
          target: "/root/potato_timer_server/"
          strip_components: 1

      - name: Deploy server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/potato_timer_server
            
            # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®æ–‡ä»¶
            echo "ðŸ“ åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®..."
            cat > .env << EOF
            # ç”Ÿäº§çŽ¯å¢ƒé…ç½®
            PORT=3000
            BASE_URL=http://8.141.116.178:3000
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            NODE_ENV=production

            ALIYUN_ACCESS_KEY_ID=${{ secrets.ALIYUN_ACCESS_KEY_ID }}
            ALIYUN_ACCESS_KEY_SECRET=${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
            
            DB_HOST=localhost
            DB_PORT=3306
            DB_USER=root
            DB_PASSWORD=hh20061202
            DB_NAME=potato_timer
            EOF
            
            # å®‰è£…ä¾èµ–
            echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
            npm install
            
            # é‡å¯æœåŠ¡
            echo "ðŸ”„ é‡å¯æœåŠ¡..."
            systemctl restart potato_timer_backend.service
            
            echo "âœ… Server éƒ¨ç½²å®Œæˆï¼"

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ æœåŠ¡å™¨éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **æœåŠ¡å™¨**: http://8.141.116.178:3000" >> $GITHUB_STEP_SUMMARY

