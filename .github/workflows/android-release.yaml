name: Android Release

on:
  push:
    branches: [main]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
  workflow_dispatch:
    inputs:
      version_number:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 2)'
        required: false
        type: string
      update_log:
        description: 'æ›´æ–°æ—¥å¿— (ä½¿ç”¨ \n åˆ†éš”å¤šè¡Œ)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release-apk:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è§£æcommitä¿¡æ¯ï¼Œæå–ç‰ˆæœ¬å·å’Œæ›´æ–°æ—¥å¿—
      - name: Parse commit message
        id: parse_commit
        run: |
          # è·å–æœ€æ–°çš„commitä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "æœ€æ–°commitä¿¡æ¯: $COMMIT_MSG"
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘
          if [ -n "${{ github.event.inputs.version_number }}" ]; then
            VERSION="${{ github.event.inputs.version_number }}"
            UPDATE_LOG="${{ github.event.inputs.update_log }}"
            echo "æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·: $VERSION"
          else
            # å°è¯•ä»commitä¿¡æ¯ä¸­æå–ç‰ˆæœ¬å· (æ ¼å¼: v2.0.0 æˆ– release: 2.0.0)
            VERSION=$(echo "$COMMIT_MSG" | grep -oP '(?<=v|release:?\s*)\d+\.\d+\.\d+' | head -1)
            
            # å¦‚æœæ²¡æ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤é€’å¢é€»è¾‘
            if [ -z "$VERSION" ]; then
              echo "ğŸ“¡ ä» GitHub Releases è·å–æœ€æ–°ç‰ˆæœ¬å·..."
              
              # ä» GitHub API è·å–æœ€æ–° Release
              LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/latest")
              
              # æå–æœ€æ–°çš„ tag_name (æ ¼å¼: v2)
              LATEST_TAG=$(echo "$LATEST_RELEASE" | grep -oP '"tag_name":\s*"v?\K\d+' || echo "0")
              
              if [ "$LATEST_TAG" = "0" ]; then
                echo "âš ï¸  æœªæ‰¾åˆ°å†å² Releaseï¼Œä» pubspec.yaml è¯»å–åˆå§‹ç‰ˆæœ¬"
                CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
                CURRENT_BUILD=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
                VERSION="${CURRENT_VERSION}+${CURRENT_BUILD}"
              else
                # ä»æœ€æ–° tag é€’å¢
                NEW_BUILD=$((LATEST_TAG + 1))
                CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
                VERSION="${CURRENT_VERSION}+${NEW_BUILD}"
                echo "âœ… æœ€æ–° Release: v${LATEST_TAG}ï¼Œæ–°ç‰ˆæœ¬: ${VERSION}"
              fi
            fi
            
            # æå–æ›´æ–°æ—¥å¿—ï¼ˆcommit messageçš„ä¸»è¦å†…å®¹ï¼‰
            UPDATE_LOG=$(echo "$COMMIT_MSG" | sed 's/v\?[0-9]\+\.[0-9]\+\.[0-9]\+//' | sed 's/release:*//i' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
            
            # å¦‚æœæ›´æ–°æ—¥å¿—ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯
            if [ -z "$UPDATE_LOG" ]; then
              UPDATE_LOG="ç‰ˆæœ¬æ›´æ–°"
            fi
          fi
          
          # æå–ç‰ˆæœ¬å·éƒ¨åˆ†
          VERSION_PART=$(echo "$VERSION" | sed 's/+.*//')
          BUILD_PART=$(echo "$VERSION" | grep -oP '(?<=\+)\d+' || echo "1")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_part=$VERSION_PART" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_PART" >> $GITHUB_OUTPUT
          echo "update_log=$UPDATE_LOG" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  å®Œæ•´ç‰ˆæœ¬: $VERSION"
          echo "  ç‰ˆæœ¬å·: $VERSION_PART"
          echo "  Buildå·: $BUILD_PART"
          echo "  æ›´æ–°æ—¥å¿—: $UPDATE_LOG"

      # 3. æ›´æ–°pubspec.yamlä¸­çš„ç‰ˆæœ¬å·
      - name: Update pubspec.yaml version
        run: |
          VERSION="${{ steps.parse_commit.outputs.version }}"
          echo "æ›´æ–° pubspec.yaml ç‰ˆæœ¬ä¸º: $VERSION"
          sed -i "s/^version:.*/version: $VERSION/" pubspec.yaml
          cat pubspec.yaml | grep '^version:'

      # 4. è®¾ç½® Java ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'

      # 6. è·å– Flutter ä¾èµ–
      - name: Install Flutter dependencies
        run: flutter pub get

      # 6.5. é…ç½®ç­¾åæ–‡ä»¶
      - name: Setup release signing
        run: |
          echo "ğŸ” é…ç½® Release ç­¾å..."
          
          # ä» GitHub Secrets è§£ç  keystore æ–‡ä»¶ï¼ˆBase64 ç¼–ç ï¼‰
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore
          
          # åˆ›å»º key.properties æ–‡ä»¶
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=app/release.keystore
          EOF
          
          echo "âœ… ç­¾åé…ç½®å®Œæˆ"

      # 7. æ„å»º Android APK (Release) - æ³¨å…¥ç”Ÿäº§ç¯å¢ƒé…ç½®
      - name: Build Android APK with production config
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º Android APK (ç”Ÿäº§ç¯å¢ƒ)..."
          flutter build apk --release \
            --dart-define=ENVIRONMENT=production \
            --dart-define=BASE_URL=http://8.141.116.178:3000
          echo "âœ… APK æ„å»ºå®Œæˆ"

      # 8. é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          BUILD_NUM=${{ steps.parse_commit.outputs.build_number }}
          cp build/app/outputs/flutter-apk/app-release.apk potato_timer_v${BUILD_NUM}.apk
          echo "ğŸ“¦ APK å·²é‡å‘½åä¸º: potato_timer_v${BUILD_NUM}.apk"
          ls -lh potato_timer_v${BUILD_NUM}.apk

      # 9. ä¸Šä¼  APK åˆ°æœåŠ¡å™¨çš„ updates ç›®å½•
      - name: Upload APK to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "potato_timer_v${{ steps.parse_commit.outputs.build_number }}.apk"
          target: "/root/potato_timer_server/updates/"
          strip_components: 0

      # 10. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 11. åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°ç‰ˆæœ¬é…ç½®
      - name: Update version config on server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/potato_timer_server 
            
            VERSION="${{ steps.parse_commit.outputs.build_number }}"
            UPDATE_LOG="${{ steps.parse_commit.outputs.update_log }}"
            DOWNLOAD_URL="http://8.141.116.178:3000/updates/potato_timer_v${VERSION}.apk"
            
            echo "ğŸ“ æ›´æ–°ç‰ˆæœ¬é…ç½®..."
            echo "   ç‰ˆæœ¬å·: $VERSION"
            echo "   ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
            echo "   æ›´æ–°æ—¥å¿—: $UPDATE_LOG"
            
            # è¿è¡Œç‰ˆæœ¬æ›´æ–°è„šæœ¬
            node scripts/update-version.js "$VERSION" "$DOWNLOAD_URL" "$UPDATE_LOG"
            
            echo "âœ… ç‰ˆæœ¬é…ç½®æ›´æ–°å®Œæˆï¼"

      # 12. åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.parse_commit.outputs.build_number }}
          name: Release v${{ steps.parse_commit.outputs.build_number }}
          body: |
            ## ç‰ˆæœ¬ ${{ steps.parse_commit.outputs.build_number }}
            
            ${{ steps.parse_commit.outputs.update_log }}
            
            ### ä¸‹è½½
            - [Android APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.parse_commit.outputs.build_number }}/potato_timer_v${{ steps.parse_commit.outputs.build_number }}.apk)
          files: |
            potato_timer_v${{ steps.parse_commit.outputs.build_number }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. é€šçŸ¥æ„å»ºç»“æœ
      - name: Build Summary
        run: |
          echo "## ğŸ‰ æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ steps.parse_commit.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ›´æ–°æ—¥å¿—**: ${{ steps.parse_commit.outputs.update_log }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK æ–‡ä»¶**: potato_timer_v${{ steps.parse_commit.outputs.build_number }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å®¢æˆ·ç«¯å°†åœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°åˆ°æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_STEP_SUMMARY
