name: Android Release & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
      - 'server/**'
  workflow_dispatch:
    inputs:
      version_number:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 2)'
        required: true
        type: string
      update_log:
        description: 'æ›´æ–°æ—¥å¿— (ä½¿ç”¨ \n åˆ†éš”å¤šè¡Œ)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Java çŽ¯å¢ƒ (Android æž„å»ºéœ€è¦)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. è®¾ç½® Flutter çŽ¯å¢ƒ
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'  # æ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´ç‰ˆæœ¬
          channel: 'stable'

      # 4. èŽ·å– Flutter ä¾èµ–
      - name: Install Flutter dependencies
        run: flutter pub get

      # 5. ä»Ž pubspec.yaml è¯»å–ç‰ˆæœ¬å·
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å½“å‰ç‰ˆæœ¬: $VERSION+$BUILD_NUMBER"

      # 6. æž„å»º Android APK (Release)
      - name: Build Android APK
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»º Android APK..."
          flutter build apk --release
          echo "âœ… APK æž„å»ºå®Œæˆ"

      # 7. é‡å‘½å APK æ–‡ä»¶
      - name: Rename APK
        run: |
          BUILD_NUM=${{ steps.version.outputs.build_number }}
          cp build/app/outputs/flutter-apk/app-release.apk potato_timer_v${BUILD_NUM}.apk
          echo "ðŸ“¦ APK å·²é‡å‘½åä¸º: potato_timer_v${BUILD_NUM}.apk"
          ls -lh potato_timer_v${BUILD_NUM}.apk

      # 8. ä¸Šä¼  APK åˆ°æœåŠ¡å™¨çš„ updates ç›®å½•
      - name: Upload APK to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "potato_timer_v${{ steps.version.outputs.build_number }}.apk"
          target: "/root/potato_timer_server/updates/"
          strip_components: 0

      # 9. è®¾ç½® Node.js çŽ¯å¢ƒ (ç”¨äºŽè¿è¡Œç‰ˆæœ¬æ›´æ–°è„šæœ¬)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 10. ä¸Šä¼ æœåŠ¡å™¨ä»£ç å’Œè„šæœ¬
      - name: Upload server files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "server/*"
          target: "/root/potato_timer_server/"
          strip_components: 1

      # 11. åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–ã€æ›´æ–°ç‰ˆæœ¬é…ç½®å¹¶é‡å¯æœåŠ¡
      - name: Deploy server and update version
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/potato_timer_server
            
            echo "ðŸ“¦ å®‰è£…/æ›´æ–°æœåŠ¡å™¨ä¾èµ–..."
            npm install --production
            
            # ç¡®å®šç‰ˆæœ¬å·å’Œæ›´æ–°æ—¥å¿—
            if [ -n "${{ github.event.inputs.version_number }}" ]; then
              VERSION="${{ github.event.inputs.version_number }}"
              UPDATE_LOG="${{ github.event.inputs.update_log }}"
            else
              VERSION="${{ steps.version.outputs.build_number }}"
              UPDATE_LOG="è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ $VERSION"
            fi
            
            # æž„å»ºä¸‹è½½ URL (æ ¹æ®ä½ çš„æœåŠ¡å™¨åŸŸåè°ƒæ•´)
            DOWNLOAD_URL="https://your-domain.com/updates/potato_timer_v${VERSION}.apk"
            
            echo "ðŸ“ æ›´æ–°ç‰ˆæœ¬é…ç½®..."
            echo "   ç‰ˆæœ¬å·: $VERSION"
            echo "   ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
            echo "   æ›´æ–°æ—¥å¿—: $UPDATE_LOG"
            
            # è¿è¡Œç‰ˆæœ¬æ›´æ–°è„šæœ¬
            node scripts/update-version.js "$VERSION" "$DOWNLOAD_URL" "$UPDATE_LOG"
            
            # é‡å¯æœåŠ¡ (æ ¹æ®ä½ çš„æœåŠ¡åç§°è°ƒæ•´)
            echo "ðŸ”„ é‡å¯æœåŠ¡..."
            if systemctl is-active --quiet potato_timer_backend; then
              systemctl restart potato_timer_backend
              echo "âœ… systemd æœåŠ¡å·²é‡å¯"
            elif pm2 list | grep -q potato_timer; then
              pm2 restart potato_timer
              echo "âœ… PM2 æœåŠ¡å·²é‡å¯"
            else
              echo "âš ï¸  æœªæ£€æµ‹åˆ°è¿è¡Œçš„æœåŠ¡ï¼Œè¯·æ‰‹åŠ¨å¯åŠ¨"
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      # 12. åˆ›å»º GitHub Release (å¯é€‰)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.build_number }}
          name: Release v${{ steps.version.outputs.build_number }}
          body: |
            ## ç‰ˆæœ¬ ${{ steps.version.outputs.build_number }}
            
            ${{ github.event.inputs.update_log || 'è‡ªåŠ¨æž„å»ºå‘å¸ƒ' }}
            
            ### ä¸‹è½½
            - [Android APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.build_number }}/potato_timer_v${{ steps.version.outputs.build_number }}.apk)
          files: |
            potato_timer_v${{ steps.version.outputs.build_number }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. é€šçŸ¥æž„å»ºç»“æžœ
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ æž„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **APK æ–‡ä»¶**: potato_timer_v${{ steps.version.outputs.build_number }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å®¢æˆ·ç«¯å°†åœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°åˆ°æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_STEP_SUMMARY

